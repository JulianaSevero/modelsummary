#' Internal function to build table with `flextable`
#'
#' @inheritParams modelsummary
#' @param stars_note passed by `modelsummary()`
#' @keywords internal
#' @return flextable object
factory_flextable <- function(tab,
                              title,
                              stars,
                              notes,
                              hrule,
                              output_file,
                              output_format,
                              ...) {
  
    # is huxtable installed?
    if (!requireNamespace('flextable', quietly = TRUE)) {
        stop("Please install the `flextable` package.")
    }
 
    table_width <- ncol(tab)

    # flextable object
    out <- flextable::flextable(tab)

    # title
    if (!is.null(title)) {
        out <- flextable::set_caption(out, title)
    }

    # horizontal rule to separate coef/gof
    if (!is.null(hrule)) {
        for (pos in hrule) {
            out <- flextable::border(out, 
                                     i = pos, 
                                     border.top = officer::fp_border())
        }
    }

    # user-supplied notes at the bottom of table
    if (!is.null(notes)) {
        for (i in length(notes):1) {
            out <- flextable::add_footer_row(out,
                                             values = notes[[i]],
                                             colwidths = table_width)
        }
    }

    # stars note
    if (!isFALSE(stars)) {
        stars_note <- make_stars_note(stars)
        out <- flextable::add_footer_row(out,
                                         values = stars_note,
                                         colwidths = table_width)
    }

    if (is.null(output_file)) {
        return(out)
    } else if (output_format == 'word') {
        flextable::save_as_docx(out, path = output_file)
    } else if (output_format == 'powerpoint') {
        flextable::save_as_pptx(out, path = output_file)
    } else if (output_format == 'png') {
        flextable::save_as_image(out, path = output_file)
    } else if (output_format == 'html') {
        flextable::save_as_html(out, path = output_file)
    }

}
